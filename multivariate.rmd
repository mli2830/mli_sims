---
title: "Multivariate analysis of categorical response variables using mixed modeling tricks"
author: Michael Li
date: "`r format(Sys.time(), '%H:%M %d %B %Y')`"
---

Categorical variables are discrete qualitative variables that are widely used in many contexts and are very easy to collect. Although it is convenient to collect categorical/qualitative data, modelling categorical response variables can be is not straight forward. Categorical variables can be further categorized into three types: Nominal, ordinal, and dichotomous. Multivariate models are complicated on its own, together with categorical variables, multivariable categorical response are pretty difficult. We will first start with multivariate dichotomous variable and then to multivariate ordinal after.

The simplest type are binary variables, where there are only two outcomes. The most common approach is by logistic regression (binomal with a logit link).

## Multivariate Binary Simulation

```{r prelims, message=FALSE, warning=FALSE}
library(MCMCglmm)
library(lme4)
library(ggplot2)
library(reshape2)
library(dplyr)
library(tidyr)
# library(rstan)
library(coda)
theme_set(theme_bw())

```

Let's tailor this simulation test with a HIV coupling application. 

Response: HIV Antibody test (seropositive/seronegative)

Predictors: Coupling time, pre-coupling time, activeness

Id: id, couple id

```{r simulate data}
set.seed(1221)
pM <- 0.5
pF <- 0.4
pMF <- 0.3

uni <- runif(n=1000)
Mresults <- (uni < pM)
Fresults <- ((uni > (pM-pMF)) & (uni > (pM + pF - pMF)))
Mpre_couplingT <- rbinom(n=1000,size=20,prob=0.3)
Fpre_couplingT <- rbinom(n=1000,size=20,prob=0.5)
couplingT <- rbinom(n=1000,size=20,prob=0.5)
Mactiveness <- rbinom(n=1000,size=1,prob=0.6)
Factiveness <- rbinom(n=1000,size=1,prob=0.4)
Cactiveness <- rbinom(n=1000,size=1,prob=0.3)
clusterid <- rbinom(n=1000,20,prob=0.5)

print(table(Mresults, Fresults))

multivar_df <- data.frame(Mresults, Fresults, 
                          Mpre_couplingT, Fpre_couplingT, 
                          couplingT, Mactiveness,Factiveness,
                          Cactiveness, clusterid,
                          id=1:1000)

head(multivar_df)


```

How that we have it in the multivariate framework, we can try to model it using MCMCglmm


```{r MCMCglmm fit, warning=FALSE,message=FALSE}

mfit <- MCMCglmm(cbind(Mresults,Fresults)~trait + Cactiveness - 1
            #     , random = ~us(trait):clusterid
                 , rcov=~us(trait):units
                 , family=c("categorical","categorical")
                 , data=multivar_df
		 , verbose=FALSE)

summary(mfit)


```

Ok, we obivously did/model it wrong. The mixing is very bad. (see eff.samp) 

Now we want to reshape/melt it into a univariate framework.

```{r univariate df, message=FALSE,warning=FALSE}

tempdat <- multivar_df %>% 
  select(c(Mresults,Fresults,Cactiveness,clusterid,id))

uni_dat <- melt(tempdat, id=c("id","clusterid","Cactiveness"),
                variable.name ="sex",value.name = "results")

head(uni_dat)

```

```{r univariate glmfit,warning=FALSE}

glmfit <- glmer(results~Cactiveness + sex -1 + (0+sex|id)
                , family="binomial"
                , data=uni_dat)

summary(glmfit)

```

